# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

variables:
  - name: buildType
    value: deploy
  - name: yourResourceGroup
    value: esAddHubResourceGroup
  - name: AzureCloudServiceConnection
    value: AzureCloudServiceConnection
  - name: location
    value: "Central US"
  - name: csmFileVar
    value: docs/reference/wingtip/armTemplates/es-add-hub.json
  - name: csmParametersFileVar
    value: docs/reference/wingtip/armTemplates/es-add-hub.parameters.json

trigger:
  branches:
    include:
    - main
  paths:
    include:
    - docs/reference/wingtip/armTemplates 

pool:
  vmImage: 'windows-latest'

steps:

- task: AzureRmDeployment@1
  inputs:
    azureSubscription: 'AzureCloudServiceConnection'
    resourceLocation: 'Central US'
    templateLocation: 'URL of the file'
    csmFileLink: 'https://raw.githubusercontent.com/manishgupta1968/Enterprise-Scale/main/docs/reference/wingtip/armTemplates/es-add-hub.json'
    csmParametersFileLink: 'https://raw.githubusercontent.com/manishgupta1968/Enterprise-Scale/main/docs/reference/wingtip/armTemplates/es-add-hub.parameters.json'
    extendedLogging: true

- task: ARM Outputs@6
  condition: eq('${{ variables.buildType }}', 'deploy')
  inputs:
    ConnectedServiceNameSelector: 'ConnectedServiceNameARM'
    ConnectedServiceNameARM: '${{ variables.AzureCloudServiceConnection }}'
    resourceGroupName: '${{ variables.yourResourceGroup }}'
    whenLastDeploymentIsFailed: 'fail'

- task: AzureCLI@2
  condition: eq('${{ variables.buildType }}', 'destroy')
  inputs:
    azureSubscription: '${{ variables.AzureCloudServiceConnection }}'
    scriptType: 'batch'
    scriptLocation: 'inlineScript'
    inlineScript: 'az group delete --yes --resource-group %1'
    arguments: '${{ variables.yourResourceGroup }}'
- task: BatchScript@1
  condition: eq('${{ variables.buildType }}', 'destroy')
  inputs:
    filename: 'putInfoOnCommit.bat'
    arguments: '\"All resources destroyed for $(yourResourceGroup)\"'